# DAHDI

## Card init

Shutdown server. Plug the card. Make sure that you plug the card with power source from CPU. Boot the server.

Login as root (or become root by using su - or sudo su - depend on Linux distribution).

To check if the hardware identified by Linux:

```
lspci
```

To check current DAHDI configuration and try to initialize them:

```
dahdi_cfg -vvv
```

To generate DAHDI configuration:

```
dahdi_genconf
dahdi_cfg -vvv
```

To view active DAHDI configuration:

```
lsdahdi
```

To restart DAHDI:

CentOS:

```
/etc/init.d/rc.redhat.asterisk stop
/etc/init.d/dahdi restart
/etc/init.d/rc.redhat.asterisk start
```

Ubuntu:

```
/etc/init.d/rc.debian.asterisk stop
/etc/init.d/dahdi restart
/etc/init.d/rc.debian.asterisk start
```

You need to stop Asterisk first and then restart DAHDI.

But in some cases using only ```/etc/init.d/dahdi restart``` is sufficient.

## Asterisk commands

Commonly used Asterisk commands for managing DAHDI:

```
dahdi show channels
dahdi show channel <channel number>
dahdi restart
```

## chan_dahdi.conf

Just like ```sip.conf```, this file is an entry point for managing DAHDI. ```chan_dahdi.conf``` is the main DAHDI configuration file.

You may put global configuration in ```chan_dahdi.conf``` while specific per ports or cards may be written in ```dahdi-channels.conf```.

Save the original ```chan_dahdi.conf```:

```
mv /etc/asterisk/chan_dahdi.conf /etc/asterisk/chan_dahdi.conf.dist
```

Create new ```/etc/asterisk/chan_dahdi.conf``` and fill with below content as default configuration:

```
; mv /etc/asterisk/chan_dahdi.conf /etc/asterisk/chan_dahdi.conf.dist
; vi /etc/asterisk/chan_dahdi.conf

[trunkgroups]

[channels]

;language=en
;rxwink=300
;usedistinctiveringdetection=no
;callwaiting=no
;usecallingpres=yes
;callwaitingcallerid=yes
;threewaycalling=yes
;transfer=yes
;canpark=yes
;cancallforward=yes
;callreturn=yes
;immediate=no

; when voice from SIP to PSTN/Mobile is not good, breaking
;jbenable=yes


; tune this options for rx/tx volume level
;rxgain=0.0
;txgain=0.0

echocancel=yes
echocancelwhenbridged=no
;echotraining=800	; disabled when using OSLEC


faxdetect=incoming	; both, incoming, outgoing, no

; call disconnection detection
;hanguponpolarityswitch=yes
busydetect=yes          ; yes no
busycount=6	        ; default 3, 6-8 better

; caller ID setup
;cidstart=ring
;cidsignalling=bell
usecallerid=yes
;cid_rxgain=3.0

; PRI spesific options
;callerid=asreceived
;overlapdial=yes
;pridialplan=local
;priindication=outofband
;nsf=none
;restrictcid=yes

; load the file that is auto-generated by dahdi_genconf

#include dahdi-channels.conf
```

## dahdi-channels.conf by dahdi_genconf

This file generated by ```dahdi_genconf```. You must make sure that this file is included by ```chan_dahdi.conf```.

In this file detail configuration of each cards and ports written. Like most Asterisk config files, the configuration read from top to bottom, whats in the bottom will overwrite the top.

Example auto-generated content of ```/etc/asterisk/dahdi-channels.conf```:

```
; This file is auto-generated by dahdi_genconf
; you should run dahdi restart for asterisk console when any changes made to this file 

; Below are only example, you should run dahdi_genconf first to configure in real situation.
; Do not replace your own dahdi-channels.conf with this one, you should only modify it

; Span 1: DAHDI_DUMMY/1 "DAHDI_DUMMY/1 (source: HRtimer) 1" (MASTER) 

; Span 2: WCT1/0 "Wildcard TE121 Card 0" 
group=0,12
context=from-trunk
switchtype = national
signalling = pri_cpe
channel => 1-23
context = default
group = 63

; Span 3: WCTDM/0 "Wildcard TDM800P Board 1" 
;;; line="29 WCTDM/0/4"
signalling=fxo_ks
callerid="Analog Phone 1" <5503>
mailbox=5503
group=5
context=office
channel => 29
callerid=
mailbox=
group=
context=default


;;; line="30 WCTDM/0/5"
signalling=fxs_ks
callerid=asreceived
group=0
context=from-trunk
channel => 30
callerid=
group=
context=default
```

## Handling incoming calls

Incoming calls handled by the ```context``` option configured in ```dahdi-channels.conf```.

For example, on line 30 the context is ```from-trunk```, it means that incoming calls to that line will be handled by dialplans in context ```from-trunk```.

Incoming calls from analog line (PSTN) will be handled on extension ```s``` in that context. While incoming calls from digital line (E1/T1) usually contains ```DID``` which mean they will be handled by specific extensions or using patterns other than ```s```.

Example dialplan to handle analog line:

```
[from-trunk]

exten = s,1,Verbose(Incoming call from PSTN line)
    same = n,Verbose(CID: ${CALLERID(num)})
    same = n,Goto(ivr-welcome,s,1)
    same = n,Hangup 
```

## Outgoing calls and analog phones

### Outgoing calls

Example calls to PSTN.

Edit ```extensions_cos.conf``` and modify context ```pstn-local```:

```
[pstn-local]
exten = _9N.,1,Dial(DAHDI/g0/${EXTEN:1})
exten = _903N.,1,Dial(DAHDI/g0/${EXTEN:3})
```

In above example calls to ```_9N.``` will be forwarded to **DAHDI lines at group=0**.

### Analog phones

Example routing extension 5601 to 5604 the call to analog phone at line 1 to 4.

Edit ```extensions_cos.conf``` and modify context ```internal```:

```
[internal]

exten = _560[1234],1,Verbose(Analog phones 1-4)
    same = n,Dial(DAHDI/${EXTEN:3})
    same = n,Hangup

exten = _55XX,1,Verbose(Internal calls)
    same = n,Dial(SIP/1${EXTEN:2})
    same = n,Hangup
```
